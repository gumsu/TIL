# 운영체제
## 프로세스와 스레드의 차이는 무엇일까?
### Process, Thread, multitasking, multi-processing, multi-threading
- `Process` 는 컴퓨터에서 실행중인 프로그램이며, 각각의 프로세스는 독립된 메모리 공간을 할당 받아 명령어들과 데이터를 가진다. 
- `Thread` 는 프로세스 내에 실행되는 흐름의 단위이다.
- `multitasking` 는 여러 프로세스를 운영체제 스케줄링에 의해 번갈아 수행되도록 하는 것이다.
  - CPU에 아주 작은 단위로 프로세스를 할당하며, 응답 시간 최소화가 목적이다.
  - **프로세스끼리 CPU를 경쟁**하며, 컨텍스트 스위칭 비용이 발생한다.
- `multi-processing` 는 두 개 이상의 프로세서나 코어를 활용하는 시스템을 말한다.
- `multi-threading` 는 하나의 프로세스가 여러 쓰레드로 동시에 여러 작업을 수행하는 것을 말한다.


### 프로세스와 스레드의 차이
- 프로세스
  - 운영체제로부터 자원을 할당받는다.
  - 프로세스는 독립된 공간의 메모리 영역(stack, heap, data, code) 을 받는다.
- 스레드
  - 프로세스가 할당받은 자원을 이용하는 실행의 단위이다.
  - 스레드는 stack을 제외한 code, data, heap 영역을 공유한다.

### 멀티 프로세스와 멀티 스레드의 차이
- 멀티 프로세스
  - 독립된 메모리 공간으로 다른 프로세스에 영향이 없다.
  - 다른 프로세스와의 자원 공유를 위해 IPC 구현이 필요하다.
- 멀티 스레드
  - 스레드끼리 메모리를 공유한다. 자원을 효율적으로 관리할 수 있다.
  - 프로세스보다 `context switching` 이 빠르다.
  - 하나의 스레드가 비정상 동작할 경우 다른 쓰레드에도 문제가 생길 수 있다.
  
### 멀티 프로세스보다 멀티 스레드가 좋은 점
- 프로세스를 생성하고 자원을 할당하는 등의 system call을 줄일 수 있어 자원을 효율적으로 관리할 수 있다.
- 프로세스 간 통신(IPC) 보다 스레드 간 통신의 비용이 더 적다.
- context switching 시 캐시 메모리를 초기화할 필요가 없어 속도가 빠르다.

### 그렇다면 무조건 멀티 스레드가 좋을까?
- 스레드 간의 자원 공유 시 동기화 문제가 발생할 수 있다.

## 컨텍스트 스위칭이란?
- 진행 중인 task 상태를 저장하고 다음에 진행할 task의 상태 값을 읽어오는 과정이다.
  
### 컨텍스트 스위칭이 왜 필요할까?
- CPU는 한 번에 하나의 프로세스만 실행 가능하다. task가 끝날때까지 다음 task는 기다려야한다. 그래서 CPU는 task를 일정 시간마다 바꿔가며 실행한다.
- 이때 실행하다 멈춘 상태를 저장하고, 다음 프로세스의 상태 값을 가져오는 작업이 필요하다.
- 프로세스의 흐름을 이어간다 = 문맥을 이어간다 = context switching

### 컨텍스트 스위칭의 흐름
1. CPU가 A프로세스를 실행하다 B프로세스로 변경하고자 한다.
2. A프로세스는 커널모드에 제어권을 넘긴다.
3. 커널모드에서 A프로세스의 상태를 저장하고 B프로세스의 상태를 로딩한다.
4. 캐시 flush, TLB를 비우고, MMU를 B프로세스를 바라보도록 변경한다.
   - **스레드는 이 과정이 없다.**
5. 커널모드에서 다시 B프로세스로 전환되어 실행한다.

### process context switching 과 thread context switching
- 공통점
  - 커널모드에서 실행된다.
    - 컨텍스트 스위칭은 OS 커널에 의해 수행된다.
  - CPU의 레지스터 상태를 교체한다.
    - 이전에 실행되고 있는 정보를 저장하는 작업을 수행한다.
- 차이점
  - 프로세스 컨텍스트 스위칭은 가상 메모리 주소 관련 처리 (MMU, TLB)를 추가로 수행해야 한다.

### 컨텍스트 스위칭의 비용
- 컨텍스트 스위칭은 많은 비용이 소모된다.
  - cache 초기화
  - memory mapping 초기화
  - kernel은 항상 실행
- 캐시 오염
  - 서로 다른 프로세스로 변경되기 때문에 CPU에 있던 캐시가 쓸모 없어진다.

## 멀티 프로세스/스레드 환경에서 동기화 문제는 어떻게 해결할까?
- 멀티 프로세스 환경에서는 여러 프로세스가 동시에 실행된다.
- 하나의 공유 자원을 여러 프로세스가 동시에 사용하려고 한다면 문제가 발생한다.

### 동기화란 무엇일까?
- 동기는 말 그대로 동시에 일어난다는 뜻이다.
- 요청과 그 결과가 동시에 일어나며, 요청이 일어나면 시간이 얼마나 걸리든지 요청한 자리에서 결과가 주어져야 한다.
- 동기화는 데이터의 일관성을 유지시킨다.

### 두 가지 관점에서의 쓰레드 동기화
- 실행 순서의 동기화
  - 스레드의 실행 순서를 정의하고 따르도록 한다.
- 메모리 접근에 대한 동기화
  - 메모리에 동시 접근을 막는다.
  - 실행 순서가 중요한 것이 아니라 한 순간에 하나의 스레드만 접근하도록 한다.
  
### 경쟁조건이란 무엇일까?
- 여러 프로세스/스레드가 동시에 같은 데이터를 조작할 때, 타이밍이나 접근 순서에 따라 결과가 달라질 수 있는 상황
- 일관성을 해친다.
- 이러한 상황을 피하기 위해 하나의 자원에 하나의 프로세스/스레드만 접근하도록 한다.

### race condition이 발생하는 경우
- 커널 작업을 수행하는 중 인터럽트 발생
- P1이 커널모드에서 데이터 조작 중 시간 초과로 제어권이 P2로 넘어가 같은 데이터를 조작하는 경우
- 멀티 프로세서 환경에서 공유 메모리 내의 커널 데이터에 접근하는 경우

### race condition 해결 방법은 무엇일까?
- 상호배제
- 동기화 (뮤텍스, 세마포어, 모니터, 락)

### 임계 영역이란 무엇일까?
- 공유데이터의 일관성을 보장하기 위해 하나의 프로세스/스레드만 진입해서 실행 가능한 영역

### critical section problem 을 해결하기 위한 기본 조건
- 상호 배제
  - 하나의 프로세스가 임계 영역에서 실행 중이라면, 다른 프로세스는 해당 영역에 접근할 수 없어야 한다.
- 진행
  - 임계 영역에서 실행 중인 프로세스가 없고, 진입하려는 프로세스들이 있다면?
    - 그 중에 누가 임계영역에 진입할 수 있을 지를 결정해야 한다. 그리고 이 선택은 무기한 연장될 수 없다.
- 한정된 대기
  - 프로세스가 임계 영역에 진입하려는 요청 후, 그 요청이 허용될 때까지 다른 프로세스들이 임계 영역에 진입하도록 허용하는 횟수에 제한이 있어야 한다.
  - 기아를 막기 위함이다.

### 어떻게 mutual exclusion 을 보장할 수 있을까?
- 상호배제 알고리즘 기법을 사용한다.
- 프로그래밍 언어와 운영체제에서 제공해준다.
